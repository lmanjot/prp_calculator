<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>PRP Dosage Calculator for Hair Restoration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        /* Modern Input Field Styles */
        .input-container {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem 1rem 1rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #ffffff;
            font-size: 1rem;
            font-weight: 500;
            color: #1e293b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .form-input:focus {
            outline: none;
            border-color: #0a9396;
            box-shadow: 0 0 0 3px rgba(10, 147, 150, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .form-input:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: scale(1.02);
        }
        
        .form-label {
            position: absolute;
            left: 1rem;
            top: 1rem;
            font-size: 1rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            background: linear-gradient(to bottom, transparent 50%, #ffffff 50%);
            padding: 0 0.25rem;
        }
        
        .form-input:focus + .form-label,
        .form-input:not(:placeholder-shown) + .form-label,
        .form-input.has-value + .form-label {
            top: -0.5rem;
            left: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #0a9396;
            background: #ffffff;
            padding: 0 0.5rem;
        }
        
        /* Input with unit styling */
        .input-with-unit {
            position: relative;
        }
        
        .input-with-unit .form-input {
            padding-right: 3.5rem;
        }
        
        .input-unit {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            pointer-events: none;
        }
        
        /* Helper text styling */
        .helper-text {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
            margin-left: 0.25rem;
        }
        
        /* Section styling improvements */
        .section-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        /* Compact collapsed state for PRP Protocol */
        .section-card.collapsed {
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .section-header.collapsed {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .section-header.collapsed .section-title {
            font-size: 1rem;
            color: #64748b;
        }
        
        .section-header.collapsed .section-icon {
            font-size: 1rem;
        }
        
        /* Hover effect for collapsible sections */
        .section-header.cursor-pointer:hover {
            background-color: #f1f5f9;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        
        .section-header.collapsed.cursor-pointer:hover {
            background-color: #e2e8f0;
        }
        
        /* Advanced label for collapsed state */
        .advanced-label {
            font-size: 0.75rem;
            color: #94a3b8;
            background: #e2e8f0;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }
        
        /* Responsive adjustments for collapsed state */
        @media (max-width: 640px) {
            .section-card.collapsed {
                padding: 0.75rem 1rem;
            }
            
            .section-header.collapsed .section-title {
                font-size: 0.9rem;
            }
            
            .advanced-label {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
                margin-left: 0.25rem;
            }
        }
        

        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .section-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, #0a9396 0%, #005f73 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.25rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }
        
        /* Button improvements */
        .calculate-button {
            width: 100%;
            background: linear-gradient(135deg, #0a9396 0%, #005f73 100%);
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 12px;
            border: none;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calculate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(10, 147, 150, 0.4), 0 4px 6px -2px rgba(10, 147, 150, 0.2);
        }
        
        .calculate-button:active {
            transform: translateY(0);
        }
        
        /* Legacy styles for results section */
        .gradient-text {
            background: linear-gradient(to right, #0a9396, #005f73);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.75rem;
            align-items: center;
            text-align: left;
        }
        
        .result-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.875rem;
        }
        
        .result-value {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.875rem;
            text-align: right;
        }
        
        /* Animation for smooth transitions */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-slate-50 py-12">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl p-6 lg:p-8 space-y-6">
        
        <div class="text-center mb-6">
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">PRP Dosage Calculator</h1>
            <p class="text-sm text-gray-500">Hair restoration treatment planning</p>
        </div>

        <div id="calculator-form" class="space-y-6">
            
            <!-- Section 1: Patient Data -->
            <div class="section-card">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div class="flex items-center">
                        <div class="section-icon mr-3">
                            👤
                        </div>
                        <h3 class="section-title mb-0">Patient Data</h3>
                    </div>
                    <div class="input-container">
                        <div class="input-with-unit">
                            <input type="number" id="thrombocytes" class="form-input" value="200" placeholder=" ">
                            <label for="thrombocytes" class="form-label">Patient Thrombocytes</label>
                            <span class="input-unit">G/L</span>
                        </div>
                        <p class="helper-text text-xs">Normal range: 150-450 G/L</p>
                    </div>
                </div>
            </div>

            <!-- Section 2: PRP Protocol -->
            <div class="section-card collapsed">
                <div class="section-header collapsed cursor-pointer" onclick="togglePrpProtocol()">
                    <div class="section-icon">
                        🧪
                    </div>
                    <h3 class="section-title">PRP Protocol</h3>
                    <span class="advanced-label">Advanced</span>
                    <div class="ml-auto">
                        <span id="prp-toggle-icon" class="text-gray-500 transition-transform duration-300">▼</span>
                    </div>
                </div>
                <div id="prp-protocol-content" class="grid grid-cols-1 sm:grid-cols-3 gap-6 hidden">
                    <div class="input-container">
                        <div class="input-with-unit">
                            <input type="number" id="prp-yield" class="form-input" value="1" step="0.1" placeholder=" " title="The exact amount of pure PRP to extract from each 10ml tube of blood.">
                            <label for="prp-yield" class="form-label">PRP Yield / Tube</label>
                            <span class="input-unit">ml</span>
                        </div>
                        <p class="helper-text">Default: 1 ml</p>
                    </div>
                    <div class="input-container">
                        <div class="input-with-unit">
                            <input type="number" id="prp-concentration" class="form-input" value="4" step="0.1" placeholder=" ">
                            <label for="prp-concentration" class="form-label">PRP Concentration</label>
                            <span class="input-unit">x</span>
                        </div>
                        <p class="helper-text">Default: 4x</p>
                    </div>
                    <div class="input-container">
                        <div class="input-with-unit">
                            <input type="number" id="ppp-concentration" class="form-input" value="0.5" step="0.1" placeholder=" ">
                            <label for="ppp-concentration" class="form-label">PPP Concentration</label>
                            <span class="input-unit">x</span>
                        </div>
                        <p class="helper-text">Default: 0.5x</p>
                    </div>
                    <div class="input-container">
                        <div class="input-with-unit">
                            <input type="number" id="recovery-rate" class="form-input" value="70" step="1" min="0" max="100" placeholder=" ">
                            <label for="recovery-rate" class="form-label">Recovery Rate</label>
                            <span class="input-unit">%</span>
                        </div>
                        <p class="helper-text">Default: 70% - % of platelets recovered from extraction (affects total count, not concentration)</p>
                    </div>
                    <div class="input-container">
                        <div class="input-with-unit">
                            <input type="number" id="activation-rate" class="form-input" value="20" step="1" min="0" max="100" placeholder=" ">
                            <label for="activation-rate" class="form-label">Activation Rate</label>
                            <span class="input-unit">%</span>
                        </div>
                        <p class="helper-text">Default: 20% - % of recovered platelets that get activated (affects total count, not concentration)</p>
                    </div>
                </div>
            </div>
            
            <div>
                <button id="calculate-btn" class="calculate-button">
                    <span class="mr-2">⚙️</span>
                    Calculate Dosage
                </button>
            </div>
        </div>

        <div id="results" class="hidden pt-8">
            <div class="border-t-2 border-gray-200 pt-8">
                <div id="concentration-feedback" class="mb-8 p-6 rounded-2xl text-center shadow-lg">
                    <p class="font-bold text-lg mb-2">PRP Concentration Analysis</p>
                    <p id="feedback-text" class="text-sm leading-relaxed"></p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Temporal/Crown Result Card -->
                    <div id="result-card-temporal_crown" class="section-card">
                        <h2 class="text-xl font-bold text-center text-gray-800 mb-6 pb-4 border-b-2 border-gray-100">Temporal / Crown</h2>
                        <div class="flex-grow flex items-center justify-around text-center border-b pb-6 mb-6">
                            <div class="text-center" id="single-spin-column-temporal_crown">
                                <p class="text-sm text-gray-600 mb-2">Starting Tubes</p>
                                <p class="text-2xl font-black gradient-text" id="tubes-single-spin-temporal_crown">0</p>
                            </div>
                            <div class="text-center" id="double-spin-column-temporal_crown" style="display: none;">
                                <p class="text-sm text-gray-600 mb-2">Final Tubes</p>
                                <p class="text-2xl font-black gradient-text" id="tubes-double-spin-temporal_crown">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600 mb-2">Extract per Tube</p>
                                <p class="text-2xl font-black gradient-text" id="extract-per-tube-temporal_crown">0 ml</p>
                            </div>
                        </div>
                        <div class="result-grid">
                            <span class="result-label">Total Injection Vol:</span>
                            <span class="result-value" id="total-volume-display-temporal_crown">0 ml</span>
                            <span class="result-label">Final Concentration:</span>
                            <span class="result-value" id="final-concentration-temporal_crown">0 M/µL</span>
                            <span class="result-label">Total Platelets Extracted:</span>
                            <div class="text-right">
                                <span class="result-value" id="total-platelets-temporal_crown">0 B</span>
                                <p class="text-xs text-gray-500 -mt-1" id="platelet-range-temporal_crown">Target: 1.5-2.0B</p>
                            </div>
                            <span class="result-label">Total PRP Volume:</span>
                            <div class="text-right">
                                <span class="result-value" id="prp-needed-temporal_crown">0 ml</span>
                                <p class="text-xs text-gray-500 -mt-1" id="prp-explanation-temporal_crown"></p>
                            </div>
                            <span class="result-label">PPP to Add:</span>
                            <span class="result-value" id="ppp-needed-temporal_crown">0 ml</span>
                            <span class="result-label">Protocol:</span>
                            <span class="result-value" id="protocol-temporal_crown">Single Spin</span>
                        </div>
                    </div>

                    <!-- Full Scalp Result Card -->
                    <div id="result-card-full_scalp" class="section-card">
                        <h2 class="text-xl font-bold text-center text-gray-800 mb-6 pb-4 border-b-2 border-gray-100">Full Scalp</h2>
                        <div class="flex-grow flex items-center justify-around text-center border-b pb-6 mb-6">
                            <div class="text-center" id="single-spin-column-full_scalp">
                                <p class="text-sm text-gray-600 mb-2">Starting Tubes</p>
                                <p class="text-2xl font-black gradient-text" id="tubes-single-spin-full_scalp">0</p>
                            </div>
                            <div class="text-center" id="double-spin-column-full_scalp" style="display: none;">
                                <p class="text-sm text-gray-600 mb-2">Final Tubes</p>
                                <p class="text-2xl font-black gradient-text" id="tubes-double-spin-full_scalp">0</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600 mb-2">Extract per Tube</p>
                                <p class="text-2xl font-black gradient-text" id="extract-per-tube-full_scalp">0 ml</p>
                            </div>
                        </div>
                        <div class="result-grid">
                            <span class="result-label">Total Injection Vol:</span>
                            <span class="result-value" id="total-volume-display-full_scalp">0 ml</span>
                            <span class="result-label">Final Concentration:</span>
                            <span class="result-value" id="final-concentration-full_scalp">0 M/µL</span>
                            <span class="result-label">Total Platelets Extracted:</span>
                            <div class="text-right">
                                <span class="result-value" id="total-platelets-full_scalp">0 B</span>
                                <p class="text-xs text-gray-500 -mt-1" id="platelet-range-full_scalp">Target: 3.0-4.0B</p>
                            </div>
                            <span class="result-label">Total PRP Volume:</span>
                            <div class="text-right">
                                <span class="result-value" id="prp-needed-full_scalp">0 ml</span>
                                <p class="text-xs text-gray-500 -mt-1" id="prp-explanation-full_scalp"></p>
                            </div>
                            <span class="result-label">PPP to Add:</span>
                            <span class="result-value" id="ppp-needed-full_scalp">0 ml</span>
                            <span class="result-label">Protocol:</span>
                            <span class="result-value" id="protocol-full_scalp">Single Spin</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-12"></div>
                
                <div id="recovery-activation-summary" class="mb-8 p-6 rounded-2xl text-center shadow-lg bg-blue-50 border border-blue-200">
                    <p class="font-bold text-lg mb-4 text-blue-800">Recovery & Activation Summary</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div class="text-center">
                            <p class="text-gray-600 mb-1">Patient Platelets</p>
                            <p class="text-2xl font-bold text-blue-600" id="patient-platelets-display">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 mb-1" id="recovered-label">Recovered (70%)</p>
                            <p class="text-2xl font-bold text-green-600" id="recovered-platelets-display">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 mb-1" id="inactivated-label">Inactivated (56%)</p>
                            <p class="text-2xl font-bold text-purple-600" id="inactivated-platelets-display">0</p>
    
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600 mb-1">Initial PRP Concentration</p>
                            <p class="text-2xl font-bold text-orange-600" id="initial-concentration-display">0 M/µL</p>
                            <p class="text-xs text-gray-500">Before double spin</p>
                        </div>
                    </div>
                    <p class="text-sm text-blue-700 mt-4">
                        <strong>Note:</strong> Recovery and activation rates reduce the total available platelets, but the concentration multiplier (4x) still applies to the remaining inactivated platelets. When initial concentration < 1.0M/µL, double spin protocol automatically activates for 7x concentration.
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = '/api'; // Relative to current domain

        // --- DOM ELEMENTS ---
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsDiv = document.getElementById('results');
        
        const thrombocytesInput = document.getElementById('thrombocytes');
        const prpYieldInput = document.getElementById('prp-yield');
        const prpConcentrationInput = document.getElementById('prp-concentration');
        const pppConcentrationInput = document.getElementById('ppp-concentration');
        const recoveryRateInput = document.getElementById('recovery-rate');
        const activationRateInput = document.getElementById('activation-rate');
        
        const feedbackDiv = document.getElementById('concentration-feedback');
        const feedbackTextEl = document.getElementById('feedback-text');

        // --- API CALCULATION LOGIC ---
        async function calculateDosage() {
            try {
                // 1. Get user inputs
                const inputData = {
                    thrombocytes: parseFloat(thrombocytesInput.value) || 0,
                    prp_yield: parseFloat(prpYieldInput.value) || 1.0,
                    prp_concentration: parseFloat(prpConcentrationInput.value) || 7.0,
                    ppp_concentration: parseFloat(pppConcentrationInput.value) || 0.5,
                    recovery_rate: parseFloat(recoveryRateInput.value) || 70.0,
                    activation_rate: parseFloat(activationRateInput.value) || 20.0
                };

                // 2. Validate required inputs
                if (!inputData.thrombocytes || inputData.thrombocytes <= 0) {
                    showError('Please enter a valid thrombocyte count greater than 0.');
                    return;
                }

                // 3. Call the API
                const response = await fetch(`${API_BASE_URL}/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer Shared1Mara!'
                    },
                    body: JSON.stringify(inputData)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                if (!result.success) {
                    throw new Error(result.message || result.error || 'Calculation failed');
                }

                // 4. Update UI with results
                updateUIWithResults(result.data);

            } catch (error) {
                console.error('Calculation error:', error);
                showError(`Calculation failed: ${error.message}`);
            }
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateUIWithResults(data) {
            const { zones, concentration_feedback, input_parameters, calculated_concentrations } = data;
            
            // Validate required data
            if (!calculated_concentrations) {
                console.error('Missing calculated_concentrations in data:', data);
                return;
            }

            // Update each zone's results
            Object.keys(zones).forEach(zoneKey => {
                const zone = zones[zoneKey];
                const explanationText = zone.tubes_needed > 0 ? 
                    `(${zone.double_spin_used ? zone.final_tubes_needed : zone.tubes_needed} tube${(zone.double_spin_used ? zone.final_tubes_needed : zone.tubes_needed) > 1 ? 's' : ''} × ${zone.extract_volume_per_tube_ml.toFixed(1)} ml)` : '';

                // Update the UI for the specific zone card
                document.getElementById(`total-volume-display-${zoneKey}`).textContent = `${zone.total_injection_volume_ml} ml`;
                document.getElementById(`prp-needed-${zoneKey}`).textContent = `${zone.total_prp_volume_ml} ml`;
                document.getElementById(`ppp-needed-${zoneKey}`).textContent = `${zone.total_ppp_needed_ml} ml`;
                
                // Update blood tubes display - show/hide columns based on protocol
                const singleSpinColumn = document.getElementById(`single-spin-column-${zoneKey}`);
                const doubleSpinColumn = document.getElementById(`double-spin-column-${zoneKey}`);
                
                if (zone.double_spin_used) {
                    // Double spin: show BOTH columns - single spin (starting) and double spin (final)
                    singleSpinColumn.style.display = 'block';
                    doubleSpinColumn.style.display = 'block';
                    document.getElementById(`tubes-single-spin-${zoneKey}`).textContent = zone.tubes_needed; // Starting tubes
                    document.getElementById(`tubes-double-spin-${zoneKey}`).textContent = zone.final_tubes_needed; // Final tubes
                } else {
                    // Single spin: show only single spin column, hide double spin column
                    singleSpinColumn.style.display = 'block';
                    doubleSpinColumn.style.display = 'none';
                    document.getElementById(`tubes-single-spin-${zoneKey}`).textContent = zone.tubes_needed;
                }
                
                document.getElementById(`prp-explanation-${zoneKey}`).textContent = explanationText;
                document.getElementById(`extract-per-tube-${zoneKey}`).textContent = `${zone.extract_volume_per_tube_ml} ml`;
                
                // Update final concentration with color coding based on status
                const concentrationEl = document.getElementById(`final-concentration-${zoneKey}`);
                concentrationEl.textContent = `${zone.final_injection_concentration_millions}M/µL`;
                
                // Color code based on concentration status
                concentrationEl.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                switch (zone.concentration_status) {
                    case 'optimal':
                        concentrationEl.classList.add('text-green-600', 'font-bold');
                        break;
                    case 'above_max':
                        concentrationEl.classList.add('text-yellow-600', 'font-bold');
                        break;
                    case 'below_min':
                        concentrationEl.classList.add('text-red-600', 'font-bold');
                        break;
                    default:
                        concentrationEl.classList.add('text-gray-600');
                }
                
                // Update total platelets extracted (using the actual extracted platelets from the treatment plan)
                const totalPlateletsB = (zone.total_platelets_extracted / 1e9).toFixed(2);
                const plateletEl = document.getElementById(`total-platelets-${zoneKey}`);
                plateletEl.textContent = `${totalPlateletsB}B`;
                
                // Color code platelets based on range status
                plateletEl.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                switch (zone.platelet_count_status) {
                    case 'optimal':
                        plateletEl.classList.add('text-green-600', 'font-bold');
                        break;
                    case 'above_max':
                        plateletEl.classList.add('text-yellow-600', 'font-bold');
                        break;
                    case 'below_min':
                        plateletEl.classList.add('text-red-600', 'font-bold');
                        break;
                    default:
                        plateletEl.classList.add('text-gray-600');
                }
                
                // Update platelet range display
                document.getElementById(`platelet-range-${zoneKey}`).textContent = `Target: ${zone.platelet_count_range}`;
                
                // Update protocol information
                const protocolEl = document.getElementById(`protocol-${zoneKey}`);
                
                if (zone.double_spin_used) {
                    protocolEl.textContent = 'Double Spin';
                    protocolEl.className = 'result-value text-purple-600 font-bold';
                } else {
                    protocolEl.textContent = 'Single Spin';
                    protocolEl.className = 'result-value text-blue-600';
                }
                
                // Update tubes explanation - REMOVED: now using separate columns for single/double spin
                
                // Note: Result card styling removed - we don't highlight cards based on concentration
                // since we need to hit the target regardless of concentration status
            });

            // Update recovery and activation summary
            try {
                const patientPlatelets = (input_parameters.thrombocytes_gl * 1000).toFixed(0);
                
                // Get recovery data from the first zone (they should all have the same recovery data)
                const firstZoneKey = Object.keys(zones)[0];
                const firstZone = zones[firstZoneKey];
                
                const recoveredPlatelets = firstZone.recovered_platelets_per_ul.toFixed(0);
                const inactivatedPlatelets = firstZone.inactivated_platelets_per_ul.toFixed(0);
                
                // Safely update DOM elements with null checks
                const patientDisplay = document.getElementById('patient-platelets-display');
                const recoveredDisplay = document.getElementById('recovered-platelets-display');
                const inactivatedDisplay = document.getElementById('inactivated-platelets-display');
                const recoveredLabel = document.getElementById('recovered-label');
                const inactivatedLabel = document.getElementById('inactivated-label');
                
                // Convert to Millions for display
                const patientPlateletsM = (parseFloat(patientPlatelets) / 1000000).toFixed(2);
                const recoveredPlateletsM = (parseFloat(recoveredPlatelets) / 1000000).toFixed(2);
                const inactivatedPlateletsM = (parseFloat(inactivatedPlatelets) / 1000000).toFixed(2);
                
                if (patientDisplay) patientDisplay.textContent = `${patientPlateletsM}M`;
                if (recoveredDisplay) recoveredDisplay.textContent = `${recoveredPlateletsM}M`;
                if (inactivatedDisplay) inactivatedDisplay.textContent = `${inactivatedPlateletsM}M`;
                
                // Update the percentage labels to show actual values
                const recoveryPercent = firstZone.effective_recovery_rate;
                const activationPercent = input_parameters.activation_rate_percent;
                const inactivatedPercent = ((100 - activationPercent) * recoveryPercent / 100).toFixed(1);
                
                if (recoveredLabel) recoveredLabel.textContent = `Recovered (${recoveryPercent.toFixed(1)}%)`;
                if (inactivatedLabel) inactivatedLabel.textContent = `Inactivated (${inactivatedPercent}%)`;
                
                // Update initial concentration display with color coding
                const initialConcentrationDisplay = document.getElementById('initial-concentration-display');
                if (initialConcentrationDisplay) {
                    const initialConcentrationM = (calculated_concentrations.final_prp_concentration_per_ul / 1000000).toFixed(2);
                    initialConcentrationDisplay.textContent = `${initialConcentrationM} M/µL`;
                    
                    // Color code based on concentration status
                    initialConcentrationDisplay.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
                    if (calculated_concentrations.final_prp_concentration_per_ul >= 1000000 && calculated_concentrations.final_prp_concentration_per_ul <= 1500000) {
                        initialConcentrationDisplay.classList.add('text-green-600'); // Good concentration (1.0-1.5M/µL)
                    } else if (calculated_concentrations.final_prp_concentration_per_ul > 1500000) {
                        initialConcentrationDisplay.classList.add('text-yellow-600'); // Above optimal range
                    } else {
                        initialConcentrationDisplay.classList.add('text-red-600'); // Below therapeutic window
                    }
                }
            } catch (error) {
                console.error('Error updating recovery/activation summary:', error);
            }
            
            // Update concentration feedback
            const feedback = concentration_feedback;
            let feedbackClass;
            
            switch (feedback.type) {
                case 'warning':
                    feedbackClass = 'mb-6 p-4 rounded-lg text-center bg-yellow-100 text-yellow-800';
                    break;
                case 'info':
                    feedbackClass = 'mb-6 p-4 rounded-lg text-center bg-blue-100 text-blue-800';
                    break;
                case 'success':
                    feedbackClass = 'mb-6 p-4 rounded-lg text-center bg-green-100 text-green-800';
                    break;
                default:
                    feedbackClass = 'mb-6 p-4 rounded-lg text-center bg-gray-100 text-gray-800';
            }
            
            feedbackDiv.className = feedbackClass;
            feedbackTextEl.innerHTML = feedback.message.replace(/(\d+\.\d+M platelets\/µL)/, '<strong>$1</strong>');

            // Show the results section
            resultsDiv.classList.remove('hidden');
            hideError();
        }

        function showError(message) {
            // Create or update error display
            let errorDiv = document.getElementById('error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'error-message';
                errorDiv.className = 'mb-6 p-4 rounded-lg text-center bg-red-100 text-red-800';
                
                // Insert before results div
                resultsDiv.parentNode.insertBefore(errorDiv, resultsDiv);
            }
            
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            errorDiv.classList.remove('hidden');
            
            // Hide results if showing
            resultsDiv.classList.add('hidden');
        }

        function hideError() {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
        }

        // --- FLOATING LABEL FUNCTIONALITY ---
        function initializeFloatingLabels() {
            const inputs = document.querySelectorAll('.form-input');
            
            inputs.forEach(input => {
                // Set initial state based on value
                if (input.value) {
                    input.classList.add('has-value');
                }
                
                // Handle input events
                input.addEventListener('input', function() {
                    if (this.value) {
                        this.classList.add('has-value');
                    } else {
                        this.classList.remove('has-value');
                    }
                });
                
                // Handle focus events for better UX
                input.addEventListener('focus', function() {
                    this.style.transform = 'scale(1.02)';
                });
                
                input.addEventListener('blur', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        }
        
        // --- ENHANCED RESULTS ANIMATION ---
        function showResults() {
            resultsDiv.classList.remove('hidden');
            resultsDiv.classList.add('animate-slide-in');
            
            // Scroll to results smoothly
            setTimeout(() => {
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        }
        
        // --- ENHANCED CALCULATE FUNCTION ---
        async function enhancedCalculateDosage() {
            // Add loading state to button
            const originalText = calculateBtn.innerHTML;
            calculateBtn.innerHTML = '<span class="mr-2">⏳</span>Calculating...';
            calculateBtn.disabled = true;
            
            try {
                // Hide any previous errors
                hideError();
                
                // Call the API calculation
                await calculateDosage();
                
                // Show results with animation
                showResults();
                
            } catch (error) {
                console.error('Enhanced calculation error:', error);
                showError(`Calculation failed: ${error.message}`);
            } finally {
                // Always reset button state
                calculateBtn.innerHTML = originalText;
                calculateBtn.disabled = false;
            }
        }

        // --- PRP PROTOCOL TOGGLE FUNCTIONALITY ---
        function togglePrpProtocol() {
            const content = document.getElementById('prp-protocol-content');
            const icon = document.getElementById('prp-toggle-icon');
            const card = content.closest('.section-card');
            const header = card.querySelector('.section-header');
            
            if (content.classList.contains('hidden')) {
                // Expanding
                content.classList.remove('hidden');
                card.classList.remove('collapsed');
                header.classList.remove('collapsed');
                icon.style.transform = 'rotate(180deg)';
                icon.textContent = '▲';
            } else {
                // Collapsing
                content.classList.add('hidden');
                card.classList.add('collapsed');
                header.classList.add('collapsed');
                icon.style.transform = 'rotate(0deg)';
                icon.textContent = '▼';
            }
        }

        // --- EVENT LISTENERS ---
        calculateBtn.addEventListener('click', enhancedCalculateDosage);
        
        // Add Enter key functionality to trigger calculate button
        document.addEventListener('keydown', function(event) {
            // Check if Enter key is pressed and we're not in a textarea or contenteditable element
            if (event.key === 'Enter' && 
                !event.target.matches('textarea') && 
                !event.target.matches('[contenteditable="true"]') &&
                !calculateBtn.disabled) {
                
                event.preventDefault(); // Prevent form submission if in a form
                enhancedCalculateDosage();
            }
        });
        
        // Initialize floating labels on page load
        document.addEventListener('DOMContentLoaded', initializeFloatingLabels);
        
        // Check for URL parameters and auto-run if platelet parameter is present
        document.addEventListener('DOMContentLoaded', function() {
            checkUrlParameters();
        });
        
        // Function to check URL parameters and auto-run calculation
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const plateletParam = urlParams.get('platelet');
            
            if (plateletParam) {
                const plateletValue = parseFloat(plateletParam);
                
                // Validate the platelet value
                if (!isNaN(plateletValue) && plateletValue > 0 && plateletValue <= 1000) {
                    // Pre-fill the thrombocyte field
                    document.getElementById('thrombocytes').value = plateletValue;
                    
                    // Auto-run the calculation
                    setTimeout(() => {
                        enhancedCalculateDosage();
                    }, 100); // Small delay to ensure DOM is ready
                }
            }
        }

    </script>
</body>
</html>
